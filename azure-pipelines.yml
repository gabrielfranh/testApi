trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  IMAGE_NAME: 'gabrielfranh/testapi'  # Nome do repositório Docker Hub
  IMAGE_TAG: '$(Build.BuildId)'       # Tag da imagem Docker

steps:
# Build and Push Docker Image
- task: Docker@2
  inputs:
    containerRegistry: 'DockerHubConnection'  # Nome da conexão Docker Hub
    repository: '$(IMAGE_NAME)'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'                # Caminho para seu Dockerfile
    tags: '$(IMAGE_TAG)'

# Install sed
- script: |
    sudo apt-get update
    sudo apt-get install -y sed
  displayName: 'Install sed'

# Configure AWS CLI
- script: |
    aws configure set aws_access_key_id $(awsAccessKeyId)
    aws configure set aws_secret_access_key $(awsSecretAccessKey)
    aws configure set region us-east-1
  displayName: 'Configure AWS CLI'
  env:
    AWS_ACCESS_KEY_ID: $(awsAccessKeyId)
    AWS_SECRET_ACCESS_KEY: $(awsSecretAccessKey)

# Download the Kubeconfig
- task: DownloadSecureFile@1
  name: downloadKubeConfig
  inputs:
    secureFile: 'kubeconfig-eks'

# Delete Existing Deployment and Service
- script: |
    export AWS_ACCESS_KEY_ID=$(awsAccessKeyId)
    export AWS_SECRET_ACCESS_KEY=$(awsSecretAccessKey)
    export AWS_DEFAULT_REGION=us-east-1
    export KUBECONFIG=$(downloadKubeConfig.secureFilePath)

    # Check if the deployment exists and delete it
    if kubectl get deployment testapi-dp > /dev/null 2>&1; then
        kubectl delete deployment testapi-dp
    fi

    # Check if the service exists and delete it
    if kubectl get svc testapi-svc > /dev/null 2>&1; then
        kubectl delete svc testapi-svc
    fi
  displayName: 'Delete Existing Kubernetes Deployment and Service'

# Apply Kubernetes Service and Create Deployment with Variable Substitution
- script: |
    export AWS_ACCESS_KEY_ID=$(awsAccessKeyId)
    export AWS_SECRET_ACCESS_KEY=$(awsSecretAccessKey)
    export AWS_DEFAULT_REGION=us-east-1
    export KUBECONFIG=$(downloadKubeConfig.secureFilePath)

    export IMAGE_TAG=$(IMAGE_TAG)

    # Replace IMAGE_TAG in the deployment.yaml
    sed "s|\$(IMAGE_TAG)|${IMAGE_TAG}|g" $(System.DefaultWorkingDirectory)/testapi-dp.yaml > $(System.DefaultWorkingDirectory)/deployment-subst.yaml

    # Apply the service manifest
    kubectl apply -f $(System.DefaultWorkingDirectory)/testapi-svc.yaml

    # Apply the new deployment manifest
    kubectl apply -f $(System.DefaultWorkingDirectory)/deployment-subst.yaml
  displayName: 'Apply Kubernetes Service and Create Deployment'